version: '3'

services:
  traefik:
    image: traefik:2.2
    restart: always
    ports:
      - "8080:80"
      - "4433:443"
    environment:
      - TZ
      - DUCKDNS_TOKEN
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - $REPO_PATH/traefik.yml:/etc/traefik/traefik.yml
      - $REPO_PATH/traefik:/config
      - $DATA_PATH/acme.json:/acme.json
    labels:
      - traefik.enable=true
      - traefik.http.routers.traefik.middlewares=auth@file
      - traefik.http.routers.traefik.entrypoints=websecure
      - traefik.http.routers.traefik.service=api@internal

  portainer:
    image: portainer/portainer
    restart: always
    environment:
      - TZ
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --no-auth
    labels:
      - traefik.enable=true
      - traefik.http.routers.portainer.middlewares=auth@file
      - traefik.http.routers.portainer.entrypoints=websecure
      - traefik.http.services.portainer.loadbalancer.server.port=9000

  duckdns:
    image: linuxserver/duckdns
    restart: always
    environment:
      - TZ
      - TOKEN=$DUCKDNS_TOKEN
      - SUBDOMAINS=$URL

  auth:
    image: thomseddon/traefik-forward-auth:2
    restart: always
    environment:
      - TZ
      - SECRET=$OAUTH_SECRET
      - PROVIDERS_GOOGLE_CLIENT_ID
      - PROVIDERS_GOOGLE_CLIENT_SECRET
      - AUTH_HOST=auth.$URL
      - COOKIE_DOMAIN=$URL
      - WHITELIST=matthewchill7@gmail.com
    labels:
      - traefik.enable=true
      - traefik.http.routers.auth.middlewares=auth@file
      - traefik.http.routers.auth.entrypoints=websecure
      - traefik.http.services.auth.loadbalancer.server.port=4181

  pihole:
    image: pihole/pihole
    restart: always
    ports:
      - "80:80"
      - "443:443"
      - "53:53"
      - "53:53/udp"
    environment:
      - TZ
      - WEBPASSWORD=
    volumes:
      - $DATA_PATH/pihole:/etc/pihole
      - $DATA_PATH/dnsmasq:/etc/dnsmasq.d
    labels:
      - traefik.enable=true
      - traefik.http.middlewares.pihole.addprefix.prefix=/admin
      - traefik.http.routers.pihole.middlewares=auth@file,pihole
      - traefik.http.routers.pihole.entrypoints=websecure
      - traefik.http.services.pihole.loadbalancer.server.port=80

  prometheus:
    image: prom/prometheus
    restart: always
    user: 1000:1000
    environment:
      - TZ
    volumes:
      - $REPO_PATH/prometheus:/etc/prometheus
      - $DATA_PATH/prometheus:/prometheus
    labels:
      - traefik.enable=true
      - traefik.http.routers.prometheus.middlewares=auth@file
      - traefik.http.routers.prometheus.entrypoints=websecure
      - traefik.http.services.prometheus.loadbalancer.server.port=9090

  grafana:
    image: grafana/grafana
    restart: always
    user: 1000:1000
    environment:
      - TZ
      - GF_AUTH_ANONYMOUS_ENABLED=true
    volumes:
      - $DATA_PATH/grafana:/var/lib/grafana
    labels:
      - traefik.enable=true
      - traefik.http.routers.grafana.middlewares=auth@file
      - traefik.http.routers.grafana.entrypoints=websecure
      - traefik.http.services.grafana.loadbalancer.server.port=3000

  jaeger:
    image: jaegertracing/all-in-one
    restart: always
    environment:
      - TZ
    labels:
      - traefik.enable=true
      - traefik.http.routers.jaeger.middlewares=auth@file
      - traefik.http.routers.jaeger.entrypoints=websecure
      - traefik.http.services.jaeger.loadbalancer.server.port=16686

  sftp:
    image: atmoz/sftp:alpine
    restart: always
    ports:
      - "2222:22"
    environment:
      - TZ
      - SFTP_USERS=mchill:$$1$$KvZr5bVS$$maxr0gZ.kIm0dRYKs3Yh91:e:1000
    volumes:
      - $REPO_PATH/id_rsa.pub:/home/mchill/.ssh/keys/id_rsa.pub:ro
      - $DATA_PATH/keys/ssh_host_ed25519_key:/etc/ssh/ssh_host_ed25519_key
      - $DATA_PATH/keys/ssh_host_rsa_key:/etc/ssh/ssh_host_rsa_key
      - $DATA_PATH:/home/mchill/server

  files:
    image: machines/filestash
    restart: always
    environment:
      - TZ
    volumes:
      - $DATA_PATH/filestash/config.json:/app/data/state/config/config.json
    labels:
      - traefik.enable=true
      - traefik.http.routers.filestash.middlewares=auth@file
      - traefik.http.routers.filestash.entrypoints=websecure
      - traefik.http.services.filestash.loadbalancer.server.port=8334

  plex:
    image: plexinc/pms-docker
    restart: always
    ports:
      - "32400:32400"
      - "32410:32410/udp"
      - "32412:32412/udp"
      - "32413:32413/udp"
      - "32414:32414/udp"
    environment:
      - TZ
      - PLEX_CLAIM
      - ADVERTISE_IP=https://plex.$URL
    volumes:
      - $DATA_PATH/plex/config:/config
      - $DATA_PATH/plex/data:/data
    labels:
      - traefik.enable=true
      - traefik.http.routers.plex.entrypoints=websecure
      - traefik.http.services.plex.loadbalancer.server.port=32400

  torrent:
    image: markusmcnugen/qbittorrentvpn
    restart: always
    privileged: true
    environment:
      - TZ
      - VPN_USERNAME
      - VPN_PASSWORD
      - VPN_ENABLED=yes
      - LAN_NETWORK=192.168.1.0/24
      - NAME_SERVERS=1.1.1.1,8.8.8.8
      - PUID=1000
      - PGID=1000
    volumes:
      - $DATA_PATH/qbittorrent/config:/config
      - $DATA_PATH/qbittorrent/downloads:/downloads
    labels:
      - traefik.enable=true
      - traefik.http.routers.qbittorrent.middlewares=auth@file
      - traefik.http.routers.qbittorrent.entrypoints=websecure
      - traefik.http.services.qbittorrent.loadbalancer.server.port=8080

  minecraft:
    image: itzg/minecraft-server
    restart: always
    ports:
      - "25565:25565"
    environment:
      - TZ
      - EULA=TRUE
      - MEMORY=3G
      - VERSION=1.16
    volumes:
      - $DATA_PATH/minecraft:/data
      - $REPO_PATH/minecraft/ops.json:/data/ops.json
      - $REPO_PATH/minecraft/whitelist.json:/data/whitelist.json
      - $REPO_PATH/minecraft/banned-ips.json:/data/banned-ips.json
      - $REPO_PATH/minecraft/banned-players.json:/data/banned-players.json

  jitsi:
    image: jitsi/web
    restart: always
    networks:
      default:
        aliases:
          - $XMPP_DOMAIN
    volumes:
      - $DATA_PATH/jitsi/web:/config
    environment:
      - TZ
      - ENABLE_AUTH
      - ENABLE_GUESTS
      - ENABLE_TRANSCRIPTIONS
      - DISABLE_HTTPS
      - JICOFO_AUTH_USER
      - XMPP_DOMAIN
      - XMPP_AUTH_DOMAIN
      - XMPP_BOSH_URL_BASE
      - XMPP_GUEST_DOMAIN
      - XMPP_MUC_DOMAIN
      - PUBLIC_URL=https://jitsi.$URL
    labels:
      - traefik.enable=true
      - traefik.http.routers.jitsi.entrypoints=websecure
      - traefik.http.services.jitsi.loadbalancer.server.port=80

  jitsi-prosody:
    image: jitsi/prosody
    restart: always
    networks:
      default:
        aliases:
          - $XMPP_SERVER
    volumes:
      - $DATA_PATH/jitsi/prosody/config:/config
      - $DATA_PATH/jitsi/prosody/prosody-plugins-custom:/prosody-plugins-custom
    environment:
      - TZ
      - AUTH_TYPE
      - ENABLE_AUTH
      - ENABLE_GUESTS
      - GLOBAL_MODULES
      - GLOBAL_CONFIG
      - XMPP_DOMAIN
      - XMPP_AUTH_DOMAIN
      - XMPP_GUEST_DOMAIN
      - XMPP_MUC_DOMAIN
      - XMPP_INTERNAL_MUC_DOMAIN
      - JICOFO_COMPONENT_SECRET
      - JICOFO_AUTH_USER
      - JICOFO_AUTH_PASSWORD
      - JVB_AUTH_USER
      - JVB_AUTH_PASSWORD
      - LOG_LEVEL

  jitsi-jicofo:
    image: jitsi/jicofo
    restart: always
    depends_on:
      - jitsi-prosody
    volumes:
      - $DATA_PATH/jitsi/jicofo:/config
    environment:
      - TZ
      - ENABLE_AUTH
      - XMPP_DOMAIN
      - XMPP_AUTH_DOMAIN
      - XMPP_INTERNAL_MUC_DOMAIN
      - XMPP_SERVER
      - JICOFO_COMPONENT_SECRET
      - JICOFO_AUTH_USER
      - JICOFO_AUTH_PASSWORD
      - JVB_BREWERY_MUC

  jitsi-jvb:
    image: jitsi/jvb
    restart: always
    depends_on:
      - jitsi-prosody
    ports:
      - "$JVB_PORT:$JVB_PORT/udp"
      - "$JVB_TCP_PORT:$JVB_TCP_PORT"
    volumes:
      - $DATA_PATH/jitsi/jvb:/config
    environment:
      - TZ
      - XMPP_AUTH_DOMAIN
      - XMPP_INTERNAL_MUC_DOMAIN
      - XMPP_SERVER
      - JVB_AUTH_USER
      - JVB_AUTH_PASSWORD
      - JVB_BREWERY_MUC
      - JVB_PORT
      - JVB_TCP_HARVESTER_DISABLED
      - JVB_TCP_PORT
      - JVB_STUN_SERVERS
